# See pyproject.toml for more cibuildwheel configuration. Putting it here is a
# problem due to GitLab CI interpreting env variables as someting it should
# render itself...
stages:
  - test
  - release

# For tagged versions, upload to PyPI
release:
  stage: release
  image: python:3.9
  dependencies:
    - linux
    - macos
    - windows
  only:
    - tags
  script:
    - python -m pip install --upgrade pip
    - pip install maturin
    # Create sdist (maturin needs cargo to do an sdist, sigh):
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain stable -y
    - PATH=~/.cargo/bin:$PATH maturin sdist
    - mkdir -p wheelhouse
    - mv target/wheels/*.tar.gz wheelhouse/
    # Upload:
    - maturin upload --username "__token__" wheelhouse/*


linux:
  image: python:3.9
  only:
    - main
    - merge_requests
    - tags
  stage: test

  # Run Docker, so cibuildwheel can use it.
  services:
    - name: docker:dind

  # Tell Docker client where to find it.
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    CIBW_BUILD: "pp3*-manylinux_x86_64 cp3*_x86_64"
    CIBW_SKIP: "pp37*"
  script:
    - curl -sSL https://get.docker.com/ | sh
    - python -m pip install cibuildwheel==2.11.3
    - cibuildwheel --output-dir wheelhouse

  artifacts:
    paths:
      - wheelhouse/


# https://docs.gitlab.com/ee/ci/runners/saas/macos_saas_runner.html
macos:
  tags:
    - shared-macos-amd64
  image: macos-11-xcode-12

  variables:
    CIBW_BUILD: "cp3*"
    MACOSX_DEPLOYMENT_TARGET: "10.15"

  script:
    - python -m pip install --upgrade pip
    - python -m pip install cibuildwheel
    - python -m cibuildwheel --output-dir wheelhouse

  artifacts:
    paths:
      - wheelhouse/

windows:
  stage: test
  tags:
    - shared-windows
    - windows
    - windows-1809

  variables:
    CIBW_BUILD: "cp3*"

  script:
    - choco install -y python --version=3.9.9
    - refreshenv
    - c:\python39\scripts\pip install cibuildwheel==2.10.2
    - c:\python39\scripts\cibuildwheel --output-dir wheelhouse

  artifacts:
    paths:
      - wheelhouse/
